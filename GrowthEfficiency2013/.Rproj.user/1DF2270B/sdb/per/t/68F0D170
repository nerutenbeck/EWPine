{
    "contents" : "###########################################################\n###\n### White Pine Growth Efficiecy Over Time\n### Nathan E. Rutenbeck\n### University of Maine School of Forest Resources\n### 2013\n###\n###########################################################\n\nsource('lme4_models.R')\nwindows()\n\n######################### Growth Efficiency\n\n#Calculate annual volume increments\n\nall.trees<-merge(DBtrees[,c(1,3:4,6:8,11)],rings[-c(8:10)],\n                 by=c('stand','plot','subplot','tree.old','year'),all.y=T) # Merge database trees with rings information\nnames(all.trees)\nhead(all.trees)\nmod.coefs<-merge(ht.mod.coefs,DBH.mod.coefs,by=('treeid'),all.y=T) # Merge coefficients from DBH and height models\nsummary(mod.coefs)\ntreeids$treeid%in%mod.coefs$treeid # Just missing two trees...\n\ntree.master<-merge(mod.coefs,all.trees,by='treeid') # Merge model coefficients with trees\ntree.master<-orderBy(~treeid+age,data=tree.master) # reorder\nhead(tree.master,100)\nsummary(tree.master)\ntreeids$treeid%in%tree.master$treeid # Still just missing two trees\n\nnames(tree.master)\n\n# diameter\n\ntree.master$ht.pred<-with(tree.master,ht.b0+I(ht.b1*DIB)+I(ht.b2*age)) # predict heights from model coefficients\ntree.master$dia.pred<-with(tree.master,d.b0+d.b1*DIB+d.b2*ht.pred+d.b3*age) # predict diameters from model coefficients\n\ntree.master$vol.pred<-with(tree.master,\n                           ((dia.pred/2.54)^2)/(0.971+(346.08/(ht.pred*3.2808399)))/35.31466672) # predict volumes from model coefficients\n\n\n# Calculate plot-level volumes\n\nplot.vols<-ddply(tree.master,.(stand,plot,year),summarize,\n                 ba=sum(ainc.cm),\n                 vol=sum(vol.pred)) # Predict volumes and basal areas at the plot level\n\nhead(plot.vols,100)\nlevels(plot.vols$plot) # These are PLOT VOLUMES in each given year, not increment!!!!\n\nplot.vols$vinc<-c(plot.vols$vol[1],rep(NA,nrow(plot.vols)-1)) # Make empty vector to store increment info\n\nfor(i in 2:nrow(plot.vols)){ \n  ifelse(plot.vols$plot[i]==plot.vols$plot[i-1], # Check if ID is same as previous\n         plot.vols$vinc[i]<-plot.vols$vol[i]-plot.vols$vol[i-1], # If same as previous, VINC= present-previous\n         plot.vols$vinc[i]<-plot.vols$vol[i]) # If it's not the same as previous, it equals itself\n} # \nhead(plot.vols)\nplot.vols$sge<-with(plot.vols,vinc/vol) # Calculate Size Growth Efficiency (increment/present volume)\n\n\nsummary(plot.vols)\nvolsmelt<-na.omit(melt(plot.vols[,-c(4:5)],id=1:3)) # Melt plot volumes for plotting purposes\n\nlong.sge<-ggplot(volsmelt,aes(y=value,x=year,lty=variable))+geom_line(cex=0.7)+\n  facet_wrap(~plot)+ylim(0,2)+xlim(1950,2012)+\n  scale_linetype_discrete(labels=c(expression('VINC ('*m^3*')'),'Size GE'))\nlong.sge # not sure how much this means looking way back, but it's interesting to see.\n\n# Merge with litter data\n\nlevels(litter$plot)%in%levels(all.trees$plot) # Chapman plot is missing\n\nge<-merge(litter,plot.vols,by=c('plot','year')) # Merge litter data with plot volumes\nlevels(ge$plot)\n\nhead(ge,100)\nge$F.GE<-with(ge,vinc/LAI) # Calculate foliar growth efficiency\nge$S.GE<-with(ge,vinc/vol) # Calculate size growth efficiency\nnames(ge)[3]<-'stand' # Rename a column\nnames(ge)\n\nge.rshp<-melt(ge[,c(1:5,11,12)],id=1:5) # Reshape the data for plotting\nhead(ge.rshp)\n\nfge.plot<-ggplot(ge.rshp[ge.rshp$plot!='Blue-Spring',],aes(y=value,x=year,color=trt,lty=variable))+\n  geom_line(cex=0.7)+facet_wrap(~plot)+\n  scale_linetype_discrete(labels=c(expression('VINC ('*m^3*')'),\n                                   'Foliar GE'))+\n  scale_color_discrete(labels=c('low density','light thin','no thin','PCT'),\n                       name='treatment')\n\nge.rshp2<-melt(ge[,c(1:5,11,13)],id=1:5)\nhead(ge.rshp2)\n\nsge.plot<-ggplot(ge.rshp2[ge.rshp2$plot!='Blue-Spring',],aes(y=value,x=year,color=trt,lty=variable))+\n  geom_line(cex=0.7)+facet_wrap(~plot)+\n  scale_linetype_discrete(labels=c(expression('VINC ('*m^3*')'),\n                                   'Size GE'))+\n  scale_color_discrete(labels=c('low density','light thin','no thin','PCT'),\n                       name='treatment')\n\n\npdf('GE_plots.pdf',height=8,width=10)\n\nlai.plot+facet_wrap(~plot) # LAI trends over time at the plot level\nfge.plot # Foliar growth efficiency\nsge.plot # Size growth efficiency (modern)\n# long.sge # Size growth efficiency (historic and probably uninformative)\n\n# Make individual plots\nplts<-levels(ge$plot)[c(1:9,26:34)]\n\npar(ask=F)\nfor(i in 1:length(plts)){\n  tmp.i=subset(ge.rshp,plot==plts[i])\n  tmp2.i=subset(ge.rshp2,plot==plts[i])\n  print(ggplot(tmp.i,aes(y=value,x=year,lty=variable))+\n          geom_line(cex=0.8)+ggtitle(plts[i])+labs(linetype='')+ylab('')+\n          scale_linetype_discrete(labels=c(expression('VINC ('*m^3*')'),'Foliar GE')))\n  print(ggplot(tmp2.i,aes(y=value,x=year,lty=variable))+\n          geom_line(cex=0.8)+ggtitle(plts[i])+labs(linetype='')+ylab('')+\n          scale_linetype_discrete(labels=c(expression('VINC ('*m^3*')'),'Size GE')))\n   \n}\n\n\ndev.off()",
    "created" : 1380804232589.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3315067023",
    "id" : "68F0D170",
    "lastKnownWriteTime" : 1380808444,
    "path" : "~/research/WP/WP_GE/Growth_efficiency.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}